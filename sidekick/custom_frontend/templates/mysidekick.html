{% extends "base.html" %}

{% block title %}mySidekick - Collaborative Knowledge Curation{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto" x-data="mysidekickApp()">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-4xl font-bold text-gray-800 mb-2">mySidekick Collaboration</h1>
        <p class="text-gray-600">Real-time collaborative knowledge curation with AI experts</p>
    </div>

    <!-- Session Creation (shown when no active session) -->
    <template x-if="!sessionId">
        <div class="bg-white rounded-xl shadow-md p-8 mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">Start New Session</h2>
            
            <form @submit.prevent="createSession">
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2">
                        Discussion Topic *
                    </label>
                    <input 
                        type="text" 
                        x-model="topic"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-600"
                        placeholder="e.g., Climate Change Solutions, AI Ethics"
                        required>
                </div>
                
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2">
                        Your Name
                    </label>
                    <input 
                        type="text" 
                        x-model="userName"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-600"
                        placeholder="Optional">
                </div>

                <button 
                    type="submit"
                    class="w-full bg-indigo-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-indigo-700 transition">
                    Start Collaborative Session
                </button>
            </form>
        </div>
    </template>

    <!-- Active Session Interface -->
    <template x-if="sessionId">
        <div class="grid md:grid-cols-3 gap-6">
            <!-- Main Conversation Panel -->
            <div class="md:col-span-2 space-y-6">
                <!-- Topic Header -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h2 class="text-2xl font-semibold text-gray-800" x-text="topic"></h2>
                    <p class="text-sm text-gray-500 mt-1">Session ID: <span x-text="sessionId"></span></p>
                </div>

                <!-- Conversation History -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <div class="h-96 overflow-y-auto mb-4 space-y-4" id="conversation">
                        <template x-for="msg in conversationHistory" :key="msg.timestamp">
                            <div :class="msg.sender === 'user' ? 'text-right' : 'text-left'">
                                <div :class="msg.sender === 'user' 
                                    ? 'inline-block bg-indigo-600 text-white rounded-lg px-4 py-2 max-w-md'
                                    : 'inline-block bg-gray-100 text-gray-800 rounded-lg px-4 py-2 max-w-md'">
                                    <p class="text-xs font-semibold mb-1" 
                                       x-text="msg.sender === 'user' ? userName : 'AI Expert'"></p>
                                    <p x-text="msg.message"></p>
                                    <template x-if="msg.response">
                                        <p class="mt-2 pt-2 border-t border-indigo-400" x-text="msg.response"></p>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- Message Input -->
                    <form @submit.prevent="sendMessage" class="flex gap-2">
                        <input 
                            type="text" 
                            x-model="messageInput"
                            class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-600"
                            placeholder="Ask a question or share insights...">
                        <button 
                            type="submit"
                            class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition">
                            Send
                        </button>
                    </form>
                </div>
            </div>

            <!-- Mind Map Panel -->
            <div class="md:col-span-1">
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Knowledge Mind Map</h3>
                    
                    <div class="space-y-2">
                        <template x-for="node in mindmap.nodes" :key="node.id">
                            <div :class="node.id === 'root' 
                                ? 'font-bold text-indigo-600 text-lg mb-4'
                                : 'ml-4 text-sm text-gray-700 py-1 px-2 bg-gray-50 rounded'">
                                <span x-text="node.label"></span>
                            </div>
                        </template>
                    </div>
                    
                    <div class="mt-6 pt-6 border-t">
                        <p class="text-xs text-gray-500">
                            Mind map updates as you explore the topic together
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </template>
</div>
{% endblock %}

{% block extra_js %}
<script>
function mysidekickApp() {
    return {
        topic: '',
        userName: 'User',
        sessionId: null,
        messageInput: '',
        conversationHistory: [],
        mindmap: { nodes: [], edges: [] },
        ws: null,
        
        async createSession() {
            const response = await fetch('/api/mysidekick/session/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    topic: this.topic,
                    user_name: this.userName 
                })
            });
            
            const data = await response.json();
            this.sessionId = data.session_id;
            this.connectWebSocket();
        },
        
        connectWebSocket() {
            this.ws = new WebSocket(`ws://localhost:8000/api/mysidekick/ws/${this.sessionId}`);
            
            this.ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                this.conversationHistory.push({
                    timestamp: new Date().toISOString(),
                    sender: 'expert',
                    message: data.response
                });
                this.mindmap = data.mindmap;
            };
        },
        
        async sendMessage() {
            if (!this.messageInput.trim()) return;
            
            const message = {
                message: this.messageInput,
                sender: 'user'
            };
            
            this.conversationHistory.push({
                timestamp: new Date().toISOString(),
                sender: 'user',
                message: this.messageInput
            });
            
            if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                this.ws.send(JSON.stringify(message));
            }
            
            this.messageInput = '';
        }
    }
}
</script>
{% endblock %}
